<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kai's Galactic Portfolio</title>
    <style>
        /* --- CORE --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #050505; overflow: hidden; font-family: 'Courier New', Courier, monospace; color: white; user-select: none; }

        /* --- UI LAYERS --- */
        #ui-layer { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); text-align: center; z-index: 100; pointer-events: none; width: 100%; transition: opacity 0.5s; }
        #hud-corner { position: absolute; bottom: 20px; right: 30px; color: #666; font-size: 0.9rem; font-weight: bold; z-index: 90; pointer-events: none; text-transform: uppercase; letter-spacing: 2px; }
        
        #score-board { position: absolute; top: 20px; right: 30px; text-align: right; z-index: 100; pointer-events: none; }
        #score-label { font-size: 0.8rem; color: #888; }
        #score-val { font-size: 2rem; color: white; font-weight: bold; transition: color 0.2s; }
        .negative-score { color: #ff4500 !important; }
        
        .score-popup { position: absolute; right: 100%; top: 10px; font-weight: bold; font-size: 1.2rem; animation: popScore 0.8s ease-out forwards; white-space: nowrap; margin-right: 10px; }
        .score-plus { color: #ffaa00; } .score-minus { color: #ff0000; }
        @keyframes popScore { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }

        .popup-msg { background: rgba(10, 20, 30, 0.95); border: 1px solid #fff; color: #fff; padding: 15px 30px; border-radius: 4px; font-size: 1rem; display: none; width: auto; max-width: 350px; margin: 0 auto; pointer-events: auto; animation: popIn 0.3s ease-out; letter-spacing: 1px; text-transform: uppercase; }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        /* --- MAP OVERLAY --- */
        #map-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 400; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        #map-container { width: 600px; height: 600px; border: 2px solid #00d2ff; background: rgba(0, 20, 40, 0.5); position: relative; border-radius: 10px; box-shadow: 0 0 50px rgba(0, 210, 255, 0.1); }
        #map-title { position: absolute; top: -40px; width: 100%; text-align: center; color: #00d2ff; font-size: 1.5rem; letter-spacing: 4px; }
        #map-instructions { position: absolute; bottom: -40px; width: 100%; text-align: center; color: #aaa; font-size: 0.9rem; }
        .map-planet { position: absolute; width: 20px; height: 20px; border-radius: 50%; transform: translate(-50%, -50%); cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .map-planet.selected { border-color: white; box-shadow: 0 0 15px white; transform: translate(-50%, -50%) scale(1.5); z-index: 10; }
        .map-label { position: absolute; top: 25px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: #ccc; white-space: nowrap; pointer-events: none; }
        #map-player { position: absolute; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 12px solid yellow; transform: translate(-50%, -50%); z-index: 5; }
        .map-photo { position: absolute; width: 14px; height: 18px; background: #eee; border-bottom: 4px solid #aaa; border-radius: 2px; transform: translate(-50%, -50%); box-shadow: 0 0 15px #00d2ff; }

        /* --- TUTORIAL --- */
        #tutorial-msg { position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%); background: rgba(5, 10, 15, 0.95); border: 2px solid #00d2ff; box-shadow: 0 0 30px rgba(0, 210, 255, 0.3); color: #00d2ff; padding: 30px 50px; border-radius: 8px; text-align: center; z-index: 300; pointer-events: none; opacity: 0; transition: opacity 0.5s; }
        #tutorial-msg h1 { margin: 0 0 10px 0; font-size: 2rem; text-transform: uppercase; letter-spacing: 3px; }
        #tutorial-msg p { color: #ddd; font-size: 1rem; line-height: 1.6; margin: 0; }
        .key-hint { color: #ffaa00; font-weight: bold; }

        /* --- CARD MODAL --- */
        #card-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 5, 0.95); z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #card-modal.active { opacity: 1; pointer-events: auto; }
        #modal-content { width: 80%; max-width: 800px; padding: 40px; background: #111; border: 2px solid #00d2ff; border-radius: 10px; text-align: center; position: relative; transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #card-modal.active #modal-content { transform: scale(1); }
        #modal-title { font-size: 2.5rem; color: #00d2ff; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        #modal-desc { font-size: 1.2rem; line-height: 1.6; color: #ddd; margin-bottom: 30px; }
        #close-btn { position: absolute; top: 20px; right: 20px; background: none; border: 1px solid #444; color: #666; padding: 5px 10px; cursor: pointer; font-family: inherit; text-transform: uppercase; }
        #close-btn:hover { color: white; border-color: white; }

        /* --- INTRO & ROCKET --- */
        #intro-layer { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 50; background: radial-gradient(circle, #1a1a1a, #000); transition: opacity 1s; }
        #intro-rocket { width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-bottom: 40px solid white; position: relative; }
        #intro-rocket::after { content: ''; position: absolute; top: 40px; left: -10px; width: 20px; height: 0; background: #ff4500; border-radius: 50%; transition: height 0.2s; box-shadow: 0 0 10px #ff4500; }
        .shaking { animation: shake 0.1s infinite; }
        .launching { animation: flyUpIntro 1.5s cubic-bezier(0.6, 0, 0.2, 1) forwards; }
        .launching::after { height: 80px !important; }
        @keyframes shake { 0% { transform: translate(0, 0) rotate(0deg); } 50% { transform: translate(2px, 2px) rotate(2deg); } 100% { transform: translate(-2px, -2px) rotate(-2deg); } }
        @keyframes flyUpIntro { 0% { transform: translateY(0); } 100% { transform: translateY(-120vh); } }

        /* --- SPACE VIEW --- */
        #space-view { position: absolute; width: 100%; height: 100%; display: none; opacity: 0; transition: opacity 1.5s ease-in-out; }
        #rocket-container { position: absolute; top: 50%; left: 50%; width: 0; height: 0; z-index: 20; }
        
        /* THE ROCINANTE */
        #rocket { position: absolute; transform: translate(-50%, -50%); width: 16px; height: 65px; transition: transform 0.1s linear; }
        #roci-body { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, #2a2a2a, #444, #2a2a2a); border-radius: 4px; box-shadow: inset 0 0 5px #000; z-index: 5; }
        #roci-body::after { content: ''; position: absolute; top: 15px; left: -1px; width: 18px; height: 6px; background: #ff4500; border-radius: 2px; }
        #roci-nose { position: absolute; top: -12px; left: 2px; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 12px solid #333; z-index: 4; }
        #roci-engine { position: absolute; bottom: -4px; left: -2px; width: 20px; height: 8px; background: #111; clip-path: polygon(10% 0, 90% 0, 100% 100%, 0% 100%); z-index: 3; }
        .leg { position: absolute; bottom: 5px; width: 4px; height: 25px; background: #555; z-index: 4; transform-origin: top center; }
        .leg.left { left: -4px; transform: rotate(15deg); } .leg.right { right: -4px; transform: rotate(-15deg); }
        #roci-plume { position: absolute; top: 65px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 0px solid cyan; filter: drop-shadow(0 0 8px #00ffff); transition: height 0.1s, border-top-width 0.1s; opacity: 0.9; z-index: 2; }
        #roci-plume::after { content: ''; position: absolute; top: -50px; left: -4px; width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 0px solid white; transition: border-top-width 0.1s; }
        .thrusting #roci-plume { border-top-width: 60px; } .thrusting #roci-plume::after { border-top-width: 40px; top: -60px; }

        #guide-arrow { position: absolute; top: 0; left: 0; width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 25px solid white; transform-origin: center 70px; transition: border-bottom-color 0.5s; }
        
        .star { position: absolute; background: white; border-radius: 50%; width: 2px; height: 2px; opacity: 0.8; }
        .bullet { position: absolute; width: 4px; height: 4px; background: #fff; box-shadow: 0 0 5px #fff, 0 0 10px cyan; border-radius: 50%; }
        .asteroid { position: absolute; background: #333; box-shadow: inset -5px -5px 15px rgba(0,0,0,0.8); }
        .planet-obj { position: absolute; border-radius: 50%; z-index: 5; transform: translate(-50%, -50%); }
        .landing-sequence { transition: transform 2.5s ease-in !important; transform: translate(-50%, -50%) scale(0.01) rotate(1080deg) !important; }

        /* --- FLOATING PHOTO CARD --- */
        #floating-photo-wrapper { position: absolute; z-index: 15; }
        #floating-photo {
            position: relative; width: 80px; height: 100px; background-color: #222;
            border: 4px solid #eee; border-bottom-width: 25px; background-size: cover; background-position: center;
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.8); transform: translate(-50%, -50%); animation: floatBob 3s ease-in-out infinite alternate;
        }
        #fp-label { position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); color: #00d2ff; font-weight: bold; text-shadow: 0 0 5px #00d2ff; white-space: nowrap; font-size: 0.9rem; letter-spacing: 2px; }
        @keyframes floatBob { 0% { transform: translate(-50%, -50%) rotate(-5deg) scale(1); } 100% { transform: translate(-50%, -50%) rotate(5deg) scale(1.1); } }

        /* --- SURFACE VIEW --- */
        #planet-view { position: absolute; width: 100%; height: 100%; display: none; overflow: hidden; opacity: 0; transition: opacity 1s ease-in-out; background: #111; }
        .gas-layer { position: absolute; width: 200%; height: 100%; background: repeating-linear-gradient(90deg, rgba(255,255,255,0.03) 0px, transparent 200px); animation: driftGas 60s linear infinite; }
        @keyframes driftGas { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        #surface-anchor { position: absolute; left: 50%; top: 100%; width: 0; height: 0; }
        #surface-container { position: absolute; width: 4000px; height: 4000px; left: -2000px; top: -300px; border-radius: 50%; background: radial-gradient(circle at 50% 0%, transparent 50%, rgba(0,0,0,0.8) 100%), #444; box-shadow: 0 0 150px rgba(255,255,255,0.2); transform-origin: center center; will-change: transform; }
        
        #astronaut { position: absolute; left: 50%; bottom: 300px; transform: translateX(-50%); width: 30px; height: 30px; z-index: 30; display: none; }
        #astro-pack { position: absolute; left: -5px; top: 5px; width: 40px; height: 20px; background: #ccc; border-radius: 5px; }
        #astro-body { position: absolute; left: 0; top: 0; width: 30px; height: 30px; background: white; border-radius: 50%; }
        #astro-visor { position: absolute; right: -2px; top: 6px; width: 18px; height: 14px; background: #111; border-radius: 40%; border: 2px solid #555; }

        #landed-rocket { position: absolute; width: 16px; height: 65px; left: 50%; top: -35px; transform: translateX(-50%); }
        #landed-rocket-body { width: 100%; height: 100%; background: #2a2a2a; border-radius: 4px; position: relative; }
        #landed-rocket-body::after { content:''; position:absolute; top:15px; left:0; width:100%; height:5px; background:#ff4500; }
        @keyframes landDescent { 0% { top: -600px; opacity: 1; transform: translateX(-50%) scale(0.5); } 70% { top: -100px; opacity: 1; transform: translateX(-50%) scale(0.8); } 100% { top: -35px; opacity: 1; transform: translateX(-50%) scale(1); } }
        .landing-descent { animation: landDescent 2.5s ease-out forwards; }
        @keyframes liftOff { 0% { top: -35px; opacity: 1; transform: translateX(-50%) scale(1); } 100% { top: -1000px; opacity: 1; transform: translateX(-50%) scale(0.2); } }
        .surface-takeoff { animation: liftOff 2s ease-in forwards; }
        #surface-plume { position: absolute; top: 65px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 0px solid cyan; filter: drop-shadow(0 0 5px cyan); transition: border-top-width 0.1s; }
        .blasting #surface-plume { border-top-width: 60px; }

        /* --- FIXED CARD STYLES --- */
        .project-window {
            position: absolute; width: 260px; height: 200px; padding: 20px;
            background: rgba(20, 20, 25, 0.95); color: #ddd; border: 2px solid #444; border-radius: 8px; font-size: 0.9rem; text-align: left;
            overflow: hidden; cursor: pointer; left: 50%; top: 50%;
            margin-left: -150px; margin-top: -120px;  
            transform-origin: center center; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            transition: transform 0.3s, background 0.3s, border-color 0.3s;
        }
        .project-window:hover { border-color: #00d2ff; background: rgba(30, 30, 40, 1); z-index: 50; }
        .card-visual { width: 100%; height: 110px; background: #000; margin-bottom: 10px; border-radius: 4px; border: 1px solid #333; background-size: cover; background-position: center; }
        .project-window h3 { margin-top: 0; color: #fff; text-transform: uppercase; letter-spacing: 1px; font-size: 1.1rem; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .card-preview-text { font-size: 0.8rem; color: #aaa; margin-top: 10px; line-height: 1.4; }

    </style>
</head>
<body>

    <div id="damage-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:red; opacity:0; pointer-events:none; transition:opacity 0.1s;"></div>
    
    <div id="card-modal">
        <div id="modal-content">
            <button id="close-btn">Close [X]</button>
            <h2 id="modal-title">Title</h2>
            <div style="width: 100%; height: 2px; background: #00d2ff; margin-bottom: 20px;"></div>
            <div id="modal-desc" style="text-align: center;">Desc</div>
            <div style="margin-top: 40px; font-size: 0.8rem; color: #666; text-align: center;">PRESS SPACE TO CLOSE</div>
        </div>
    </div>

    <div id="map-overlay">
        <div id="map-container">
            <div id="map-title">SECTOR MAP</div>
            <div id="map-player"></div>
            <div id="map-instructions">ARROWS to Select &nbsp;|&nbsp; SPACE to Warp &nbsp;|&nbsp; M to Close</div>
        </div>
    </div>

    <div id="tutorial-msg"></div>
    
    <div id="score-board">
        <div id="score-label">SCORE</div>
        <div id="score-val">0</div>
        <div id="score-popups"></div>
    </div>

    <div id="hud-corner">M - MAP</div>

    <div id="ui-layer">
        <h1 id="main-msg" style="color:white; font-size: 1.5rem; letter-spacing: 4px;">HOLD CLICK TO LAUNCH</h1>
        <div id="popup-welcome" class="popup-msg">ATMOSPHERE ENTRY</div>
        <div id="popup-exit" class="popup-msg">Press <b>SPACE</b> to Exit Ship, and use the <b>ARROW KEYS</b> to move</div>
        <div id="popup-enter" class="popup-msg">Press <b>SPACE</b> to Enter Ship</div>
        <div id="popup-interact" class="popup-msg" style="color:#00d2ff; border-color:#00d2ff;"><b>CLICK</b> to Open</div>
    </div>

    <div id="intro-layer"><div id="intro-rocket"></div></div>

    <div id="space-view">
        <div id="space-bg"></div>
        <div id="universe" style="position: absolute; top:0; left:0; width:0; height:0;">
            </div>
        <div id="rocket-container">
            <div id="guide-arrow"></div>
            <div id="rocket">
                <div id="roci-nose"></div>
                <div id="roci-body"></div>
                <div id="roci-engine"></div>
                <div class="leg left"></div>
                <div class="leg right"></div>
                <div id="roci-plume"></div>
            </div>
        </div>
    </div>

    <div id="planet-view">
        <div class="gas-layer"></div>
        <div id="planet-stars"></div>
        <div id="astronaut">
            <div id="astro-pack"></div>
            <div id="astro-body"><div id="astro-visor"></div></div>
        </div>
        <div id="surface-anchor">
            <div id="surface-container">
                <div id="landed-rocket">
                    <div id="landed-rocket-body"></div>
                    <div class="leg left" style="bottom: 0; height: 15px; transform: rotate(25deg); left: -6px;"></div>
                    <div class="leg right" style="bottom: 0; height: 15px; transform: rotate(-25deg); right: -6px;"></div>
                    <div id="surface-plume"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        const GAME_CONFIG = {
            physics: {
                universeSize: 8000, thrust: 0.1, friction: 0.98, turnSpeed: 3, 
                gravity: 0.4, planetGravity: 0.05, walkSpeed: 3.5, jumpPower: 14           
            },

            // --- THE FLOATING PHOTO CARD ---
            floatingPhoto: {
                x: 0, y: -400, radius: 45,
                img: "waffle.png", 
                title: "Hello, I'm Kai",
                desc: "I'm a current sophmore at Woodside High School, \nand I love engineering and aerospace! Fly around to find the rest of my porfolio!"
            },

            // --- PLANETS & CARDS ---
            planets: [
                {
                    id: 'p-web', name: 'Projects', x: 2500, y: 2000, radius: 250, 
                    color: '#4caf50', skyColor: '#0f2e0f', groundColor: '#2b8b2b',
                    cards: [ 
                        { 
                            angle: 35, title: "3DOF Kinematics", preview: "Fall 2025", desc: "Coded the inverse and forward kinematics for a 3DOF robotic arm (pictured above)", color: "#444",
                            img: "calgamesrobot.png" // Example Image URL
                        }, 
                        { 
                            angle:-35, title: "High Torque Climber", preview: "Spring 2026", desc: "Led a team of peers to design and fabricate a climber capable of flipping a 150lb robot upside down in 1.5 seconds.", color: "#444",
                            img: "climbercad.png" // Leave blank to just use the gradient color block
                        }, 
                        { 
                            angle: 240, title: "EMG Gripper", preview: "Spring 2025", desc: "Designed and lasercut a gripper controlled by muscle movements in the forearm, capable of lifting over a kilogram", color: "#444",
                            img: "" 
                        } 
                    ]
                },
                {
                    id: 'p-games', name: 'Education', x: -2000, y: -1500, radius: 180, 
                    color: '#ff4500', skyColor: '#2e0f0f', groundColor: '#8b0000',
                    cards: [ 
                        { angle: 35, title: "Woodside High School", preview: "Class of 2028", desc: "Accredited high school in Woodside, CA. Took many advanced classes including AP Calculus, AP CSA and Engineering Design and Development", color: "#888", img: "whs.png" }, 
                        { angle: -35, title: "Masters in Mechanical Engineering", preview: "Aspiring Student at Caltech", desc: "A masters in mechanical engineering would ensure I have the diverse skills needed to work on frontier aerospace projects. Caltech is a famed engineering school with ties to NASA's JPL laboratory", color: "#888", img: "" } 
                    ]
                },
                {
                    id: 'p-exp', name: 'Prior Expierence and Interests', x: 1000, y: -2500, radius: 200, 
                    color: '#00ffff', skyColor: '#003333', groundColor: '#008b8b',
                    cards: [ 
                        { angle: 35, title: "FRC Team 100 Wildhats", preview: "Lead Position on Competitive Robotics Team; 2024-", desc: "Headed several complex projects across diciplines, designing and fabricating dozens of parts. ", color: "#005555", img: "goodlogo.png" }, 
                        { angle: -60, title: "KRKiS", preview: "Columnist; 2025-", desc: "Composed analystical articles about culture and today's world for a foriegn audience", color: "#005555", img: "krkis.png" },
                        { angle: -35, title: "Interests", preview: "Engineering, Aerospace and more", desc: "My primary interest if aerospace, including projects like Starship and Artemis. I also play D&D, act in hobby short films, and take advantage of the wonderful nature near me", color: "#005555", img: "coolkai.jpg" } 

                    ]
                    
                },
                {
                    id: 'p-contact', name: 'Contact', x: -2500, y: 2000, radius: 150, 
                    color: '#aaaaaa', skyColor: '#111111', groundColor: '#555555',
                    cards: [ 
                        { angle: 35, title: "Email Me", preview: "kymontauk@gmail.com", desc: "The best way to reach me with serious inquiries for work", color: "#333", img: "" }, 
                        { angle: -35, title: "Socials", preview: "GitHub / LinkedIn", desc: "GitHub: @GeniusKoi\nLinkedIn: Kai Montauk", color: "#333", img: "" } 
                    ]
                }
            ]
        };

        // --- AUDIO ENGINE ---
        class AudioController {
            constructor() { this.ctx = null; this.enabled = false; this.thrustOsc = null; this.thrustGain = null; this.chargeOsc = null; }
            init() { if(this.enabled) return; const AC = window.AudioContext || window.webkitAudioContext; this.ctx = new AC(); this.enabled = true; }
            play(type) {
                if(!this.enabled) return;
                const t = this.ctx.currentTime; const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination);
                switch(type) {
                    case 'shoot': osc.type='square'; osc.frequency.setValueAtTime(800,t); osc.frequency.exponentialRampToValueAtTime(100,t+0.15); gain.gain.setValueAtTime(0.05,t); gain.gain.exponentialRampToValueAtTime(0.01,t+0.15); osc.start(t); osc.stop(t+0.15); break;
                    case 'hit': osc.type='sawtooth'; osc.frequency.setValueAtTime(100,t); osc.frequency.exponentialRampToValueAtTime(10,t+0.3); gain.gain.setValueAtTime(0.2,t); gain.gain.linearRampToValueAtTime(0,t+0.3); osc.start(t); osc.stop(t+0.3); break;
                    case 'point': osc.type='sine'; osc.frequency.setValueAtTime(1200,t); osc.frequency.setValueAtTime(1800,t+0.1); gain.gain.setValueAtTime(0.1,t); gain.gain.linearRampToValueAtTime(0,t+0.2); osc.start(t); osc.stop(t+0.2); break;
                    case 'step': osc.type='triangle'; osc.frequency.setValueAtTime(150,t); osc.frequency.exponentialRampToValueAtTime(50,t+0.05); gain.gain.setValueAtTime(0.05,t); gain.gain.linearRampToValueAtTime(0,t+0.05); osc.start(t); osc.stop(t+0.05); break;
                    case 'whoosh': osc.type='sine'; osc.frequency.setValueAtTime(100,t); osc.frequency.linearRampToValueAtTime(400,t+1); gain.gain.setValueAtTime(0,t); gain.gain.linearRampToValueAtTime(0.2,t+0.5); gain.gain.linearRampToValueAtTime(0,t+1); osc.start(t); osc.stop(t+1); break;
                    case 'launch': osc.type='sawtooth'; osc.frequency.setValueAtTime(200,t); osc.frequency.exponentialRampToValueAtTime(50,t+2); gain.gain.setValueAtTime(0.3,t); gain.gain.linearRampToValueAtTime(0,t+2); osc.start(t); osc.stop(t+2); break;
                }
            }
            startCharge() {
                if(!this.enabled || this.chargeOsc) return;
                const t = this.ctx.currentTime;
                this.chargeOsc = this.ctx.createOscillator(); this.chargeGain = this.ctx.createGain();
                this.chargeOsc.type = 'sawtooth'; this.chargeOsc.frequency.setValueAtTime(50, t);
                this.chargeOsc.frequency.linearRampToValueAtTime(150, t+1.5); 
                this.chargeGain.gain.setValueAtTime(0, t); this.chargeGain.gain.linearRampToValueAtTime(0.2, t+1.5);
                const filter = this.ctx.createBiquadFilter(); filter.type="lowpass"; filter.frequency.value=150;
                this.chargeOsc.connect(filter); filter.connect(this.chargeGain); this.chargeGain.connect(this.ctx.destination);
                this.chargeOsc.start(t);
            }
            stopCharge() { if(this.chargeOsc) { const t=this.ctx.currentTime; this.chargeGain.gain.linearRampToValueAtTime(0,t+0.1); this.chargeOsc.stop(t+0.1); this.chargeOsc=null; } }
            startThrust() {
                if(!this.enabled || this.thrustOsc) return;
                const t = this.ctx.currentTime;
                this.thrustOsc = this.ctx.createOscillator(); this.thrustGain = this.ctx.createGain();
                this.thrustOsc.type='sawtooth'; this.thrustOsc.frequency.value=60;
                this.thrustGain.gain.setValueAtTime(0,t); this.thrustGain.gain.linearRampToValueAtTime(0.1,t+0.1);
                const filter=this.ctx.createBiquadFilter(); filter.type="lowpass"; filter.frequency.value=250;
                this.thrustOsc.connect(filter); filter.connect(this.thrustGain); this.thrustGain.connect(this.ctx.destination); this.thrustOsc.start(t);
            }
            stopThrust() { if(this.thrustOsc) { const t=this.ctx.currentTime; this.thrustGain.gain.linearRampToValueAtTime(0,t+0.1); this.thrustOsc.stop(t+0.1); this.thrustOsc=null; } }
        }
        const audio = new AudioController();

        let mode = 'pre-launch'; 
        let keys = {};
        let ship = { x: 0, y: 0, vx: 0, vy: 0, angle: 0 };
        let astro = { angle: 0, height: 0, vy: 0, bobTimer: 0 }; 
        let stars = [], bullets = [], asteroids = [];
        let score = 0, interactionCooldown = false, nearbyCardIndex = -1;
        let mapOpen = false, mapSelectIndex = 0, currentPlanetData = null;

        const universe = document.getElementById('universe');
        const rocket = document.getElementById('rocket');
        const arrow = document.getElementById('guide-arrow');
        const scoreVal = document.getElementById('score-val');
        const scorePopups = document.getElementById('score-popups');
        const surfaceContainer = document.getElementById('surface-container');
        const planetView = document.getElementById('planet-view');
        const spaceView = document.getElementById('space-view');
        const mainMsg = document.getElementById('main-msg');
        const introRocket = document.getElementById('intro-rocket');
        const landedRocket = document.getElementById('landed-rocket');
        const cardModal = document.getElementById('card-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalDesc = document.getElementById('modal-desc');
        const closeBtn = document.getElementById('close-btn');
        const tutorialMsg = document.getElementById('tutorial-msg');
        const mapOverlay = document.getElementById('map-overlay');
        const mapContainer = document.getElementById('map-container');
        const mapPlayer = document.getElementById('map-player');

        function getWrappedDiff(p1, p2, size) {
            let diff = p1 - p2; if (diff < -size / 2) diff += size; if (diff > size / 2) diff -= size; return diff;
        }

        window.addEventListener('keydown', e => {
            if(mode === 'pre-launch') return;
            if (e.key.toLowerCase() === 'm' && mode === 'flying') { toggleMap(); return; }
            if (mapOpen) {
                if(e.key === 'ArrowRight') cycleMapSelection(1);
                if(e.key === 'ArrowLeft') cycleMapSelection(-1);
                if(e.code === 'Space') warpToSelected();
                return;
            }
            keys[e.key] = true;
            if (e.code === 'Space') {
                if(mode === 'flying') fireBullet();
                if(mode === 'walking') handleInteraction();
                if(mode === 'reading_card' || mode === 'reading_photo') closeCard();
            }
        });
        window.addEventListener('keyup', e => keys[e.key] = false);
        closeBtn.addEventListener('click', closeCard);

        let holdTimer;
        window.addEventListener('mousedown', () => {
            audio.init(); 
            if(mode === 'pre-launch') { introRocket.classList.add('shaking'); mainMsg.innerText = "IGNITION..."; audio.startCharge(); holdTimer = setTimeout(introSequence, 1000); }
            if(mode === 'landed_in_ship') { landedRocket.classList.add('shaking'); mainMsg.innerText = "CHARGING..."; audio.startCharge(); holdTimer = setTimeout(planetTakeoff, 1000); }
        });
        window.addEventListener('mouseup', () => {
            clearTimeout(holdTimer); audio.stopCharge();
            if(mode === 'pre-launch') { introRocket.classList.remove('shaking'); mainMsg.innerText = "HOLD CLICK TO LAUNCH"; }
            if(mode === 'landed_in_ship') { landedRocket.classList.remove('shaking'); mainMsg.innerText = "HOLD CLICK TO LAUNCH"; }
        });

        function introSequence() {
            mode = 'launching'; audio.stopCharge(); audio.play('launch'); introRocket.classList.add('launching'); mainMsg.style.display = 'none';
            setTimeout(() => { document.getElementById('intro-layer').style.display = 'none'; initGame(); }, 1000);
        }

        function initGame() {
            mode = 'flying'; spaceView.style.display = 'block'; setTimeout(() => spaceView.style.opacity = 1, 50);
            createStars(); spawnAsteroids(25); generateUniverseDOM(); initMap(); runTutorialSequence(); requestAnimationFrame(gameLoop);
        }

        function generateUniverseDOM() {
            GAME_CONFIG.planets.forEach(p => {
                let el = document.createElement('div'); el.className = 'planet-obj'; el.id = p.id;
                el.style.width = (p.radius * 2) + 'px'; el.style.height = (p.radius * 2) + 'px';
                el.style.background = `radial-gradient(circle at 30% 30%, ${p.color}, #000)`; el.style.boxShadow = `0 0 50px ${p.color}`;
                universe.appendChild(el);
            });

            let fpWrapper = document.createElement('div');
            fpWrapper.id = 'floating-photo-wrapper';
            
            let fp = document.createElement('div');
            fp.id = 'floating-photo';
            fp.style.backgroundImage = `url('${GAME_CONFIG.floatingPhoto.img}')`;
            
            let fpLabel = document.createElement('div');
            fpLabel.id = 'fp-label';
            fpLabel.innerText = "ABOUT ME";
            fp.appendChild(fpLabel);
            
            fpWrapper.appendChild(fp);
            universe.appendChild(fpWrapper);
        }

        function runTutorialSequence() {
            setTimeout(() => { tutorialMsg.innerHTML = "<h1>Welcome to<br>Kai's Portfolio</h1>"; tutorialMsg.style.opacity = 1; audio.play('point'); }, 500);
            setTimeout(() => { tutorialMsg.style.opacity = 0; setTimeout(() => { tutorialMsg.innerHTML = `<p><span class="key-hint">ARROWS</span> to Fly<br><span class="key-hint">SPACE</span> to Shoot<br><span class="key-hint">M</span> for Star Map</p>`; tutorialMsg.style.opacity = 1; audio.play('point'); }, 500); }, 3000);
            setTimeout(() => { tutorialMsg.style.opacity = 0; }, 7000);
        }

        function buildSurfaceCards() {
            const old = surfaceContainer.querySelectorAll('.project-window'); old.forEach(o => o.remove());
            if (!currentPlanetData) return;
            currentPlanetData.cards.forEach((c, index) => {
                let div = document.createElement('div'); div.className = 'project-window'; div.id = `card-${index}`;
                div.style.transform = `rotate(${c.angle}deg) translateY(-2150px)`;
                
                // If the card has an image, use it, otherwise use a gradient color block
                let visualStyle = c.img ? `background-image: url('${c.img}');` : `background: linear-gradient(45deg, ${c.color || currentPlanetData.color}, #111);`;
                
                div.innerHTML = `<div class="card-visual" style="${visualStyle}"></div><h3>${c.title}</h3><div class="card-preview-text">${c.preview}</div>`;
                div.addEventListener('click', (e) => { e.stopPropagation(); if(mode === 'walking') openCard(c); });
                surfaceContainer.appendChild(div);
            });
        }

        function createStars() {
            const bg = document.getElementById('space-bg');
            for(let i=0; i<200; i++) {
                let s = document.createElement('div'); s.className = 'star';
                let x = Math.random() * window.innerWidth; let y = Math.random() * window.innerHeight;
                s.style.transform = `translate(${x}px, ${y}px)`; bg.appendChild(s); stars.push({ el: s, x: x, y: y });
            }
        }

        function initMap() {
            const mapScale = 600 / GAME_CONFIG.physics.universeSize;
            
            let pDot = document.createElement('div');
            pDot.className = 'map-photo';
            let pmx = 300 + (GAME_CONFIG.floatingPhoto.x * mapScale);
            let pmy = 300 + (GAME_CONFIG.floatingPhoto.y * mapScale);
            pDot.style.left = pmx + 'px'; pDot.style.top = pmy + 'px';
            pDot.innerHTML = `<div class="map-label">PHOTO ID</div>`;
            mapContainer.appendChild(pDot);

            GAME_CONFIG.planets.forEach((p, i) => {
                let dot = document.createElement('div'); dot.className = 'map-planet'; dot.id = `map-planet-${i}`;
                dot.style.backgroundColor = p.color;
                let mx = 300 + (p.x * mapScale); let my = 300 + (p.y * mapScale);
                dot.style.left = mx + 'px'; dot.style.top = my + 'px';
                let label = document.createElement('div'); label.className = 'map-label'; label.innerText = p.name;
                dot.appendChild(label); mapContainer.appendChild(dot);
            });
            updateMapSelection();
        }

        function toggleMap() { mapOpen = !mapOpen; if (mapOpen) { mapOverlay.style.display = 'flex'; audio.play('point'); } else { mapOverlay.style.display = 'none'; } }
        function updateMapDisplay() {
            if(!mapOpen) return;
            const mapScale = 600 / GAME_CONFIG.physics.universeSize;
            let px = 300 + (ship.x * mapScale); let py = 300 + (ship.y * mapScale);
            if(px < 0) px += 600; if(px > 600) px -= 600; if(py < 0) py += 600; if(py > 600) py -= 600;
            mapPlayer.style.left = px + 'px'; mapPlayer.style.top = py + 'px';
            mapPlayer.style.transform = `translate(-50%, -50%) rotate(${ship.angle}deg)`;
        }
        function cycleMapSelection(dir) { mapSelectIndex += dir; if(mapSelectIndex < 0) mapSelectIndex = GAME_CONFIG.planets.length - 1; if(mapSelectIndex >= GAME_CONFIG.planets.length) mapSelectIndex = 0; updateMapSelection(); audio.play('step'); }
        function updateMapSelection() { document.querySelectorAll('.map-planet').forEach(el => el.classList.remove('selected')); document.getElementById(`map-planet-${mapSelectIndex}`).classList.add('selected'); }
        function warpToSelected() { toggleMap(); audio.play('whoosh'); let target = GAME_CONFIG.planets[mapSelectIndex]; ship.x = target.x; ship.y = target.y - (target.radius + 400); ship.vx = 0; ship.vy = 0; triggerLanding(target); }

        function gameLoop() {
            if (mapOpen) { updateMapDisplay(); updateShip(); } else {
                if (mode === 'flying') { updateShip(); updateBullets(); updateAsteroids(); }
                if (mode === 'walking') updateWalking();
            }
            requestAnimationFrame(gameLoop);
        }

        function updateShip() {
            const P = GAME_CONFIG.physics; const U = P.universeSize;
            if(!mapOpen) {
                if(keys['ArrowLeft']) ship.angle -= P.turnSpeed;
                if(keys['ArrowRight']) ship.angle += P.turnSpeed;
                if(keys['ArrowUp']) {
                    rocket.classList.add('thrusting');
                    let rad = (ship.angle - 90) * (Math.PI / 180);
                    ship.vx += Math.cos(rad) * P.thrust; ship.vy += Math.sin(rad) * P.thrust;
                    audio.startThrust();
                } else { rocket.classList.remove('thrusting'); audio.stopThrust(); }
            } else { audio.stopThrust(); }

            // ship.vx *= P.friction; ship.vy *= P.friction;
            ship.x += ship.vx; ship.y += ship.vy;
            if(ship.x > U/2) ship.x -= U; if(ship.x < -U/2) ship.x += U; if(ship.y > U/2) ship.y -= U; if(ship.y < -U/2) ship.y += U;

            stars.forEach(star => {
                star.x -= ship.vx * 0.5; star.y -= ship.vy * 0.5;
                if(star.x<0) star.x+=window.innerWidth; if(star.x>window.innerWidth) star.x-=window.innerWidth;
                if(star.y<0) star.y+=window.innerHeight; if(star.y>window.innerHeight) star.y-=window.innerHeight;
                star.el.style.transform = `translate(${star.x}px, ${star.y}px)`;
            });

            let closestDist = Infinity; let closestPlanet = null;
            GAME_CONFIG.planets.forEach(p => {
                let dx = getWrappedDiff(p.x, ship.x, U); let dy = getWrappedDiff(p.y, ship.y, U);
                let screenX = (window.innerWidth/2) + dx; let screenY = (window.innerHeight/2) + dy;
                let el = document.getElementById(p.id);
                if(el) el.style.transform = `translate(${screenX}px, ${screenY}px) translate(-50%, -50%)`;

                let dist = Math.hypot(dx, dy);
                if(dist < closestDist) { closestDist = dist; closestPlanet = p; }
                
                if (dist < p.radius + 800) {
                    let force = P.planetGravity * (1 - (dist / (p.radius + 800)));
                    let angle = Math.atan2(dy, dx);
                    ship.vx += Math.cos(angle) * force; ship.vy += Math.sin(angle) * force;
                }
                if(dist < p.radius + 20 && !mapOpen) triggerLanding(p);
            });

            // --- FLOATING PHOTO LOGIC ---
            const FP = GAME_CONFIG.floatingPhoto;
            let fpDx = getWrappedDiff(FP.x, ship.x, U);
            let fpDy = getWrappedDiff(FP.y, ship.y, U);
            let fpWrapper = document.getElementById('floating-photo-wrapper');
            if(fpWrapper) {
                fpWrapper.style.transform = `translate(${(window.innerWidth/2) + fpDx}px, ${(window.innerHeight/2) + fpDy}px)`;
            }

            let fpDist = Math.hypot(fpDx, fpDy);
            if(fpDist < FP.radius + 20 && !mapOpen && !interactionCooldown && mode === 'flying') {
                ship.x -= ship.vx * 15; ship.y -= ship.vy * 15; ship.vx = 0; ship.vy = 0;
                openPhotoCard(FP);
            }

            if(closestPlanet) {
                let dx = getWrappedDiff(closestPlanet.x, ship.x, U); let dy = getWrappedDiff(closestPlanet.y, ship.y, U);
                let angle = Math.atan2(dy, dx) * (180/Math.PI);
                arrow.style.transform = `translate(-50%, -50%) rotate(${angle + 90}deg) translateY(-60px)`;
                arrow.style.borderBottomColor = closestPlanet.color;
            }
            rocket.style.transform = `translate(-50%, -50%) rotate(${ship.angle}deg)`;
        }

        function fireBullet() {
            audio.play('shoot');
            let b = document.createElement('div'); b.className = 'bullet'; universe.appendChild(b);
            let rad = (ship.angle - 90) * (Math.PI / 180);
            let bx = ship.x + Math.cos(rad) * 30; let by = ship.y + Math.sin(rad) * 30;
            bullets.push({ el: b, x: bx, y: by, vx: Math.cos(rad)*10 + ship.vx, vy: Math.sin(rad)*10 + ship.vy, life: 100 });
        }

        function spawnAsteroids(count, x, y, size) {
            for(let i=0; i<count; i++) {
                let a = document.createElement('div'); a.className = 'asteroid';
                let spawnX = x !== undefined ? x : (Math.random() - 0.5) * GAME_CONFIG.physics.universeSize;
                let spawnY = y !== undefined ? y : (Math.random() - 0.5) * GAME_CONFIG.physics.universeSize;
                let sClass = size || 3; let pxSize = sClass * 20 + 10; 
                a.style.width = pxSize + 'px'; a.style.height = pxSize + 'px';
                
                let points = "";
                for(let k=0; k<8; k++) {
                    let ang = (k / 8) * Math.PI * 2; let rad = 40 + Math.random() * 60;
                    points += `${50 + Math.cos(ang) * rad/2}% ${50 + Math.sin(ang) * rad/2}%,`;
                }
                a.style.clipPath = `polygon(${points.slice(0,-1)})`;
                let cx = 30 + Math.random()*40; let cy = 30 + Math.random()*40;
                a.style.background = `radial-gradient(circle at ${cx}% ${cy}%, #222 10%, #444 60%)`;

                universe.appendChild(a);
                asteroids.push({ el: a, x: spawnX, y: spawnY, vx: (Math.random()-0.5)*(4-sClass), vy: (Math.random()-0.5)*(4-sClass), size: sClass, radius: pxSize/2 });
            }
        }

        function updateBullets() {
            const U = GAME_CONFIG.physics.universeSize;
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i]; b.x += b.vx; b.y += b.vy; b.life--;
                if(b.x > U/2) b.x -= U; if(b.x < -U/2) b.x += U; if(b.y > U/2) b.y -= U; if(b.y < -U/2) b.y += U;
                let dx = getWrappedDiff(b.x, ship.x, U); let dy = getWrappedDiff(b.y, ship.y, U);
                b.el.style.transform = `translate(${(window.innerWidth/2)+dx}px, ${(window.innerHeight/2)+dy}px)`;
                if(b.life <= 0) { b.el.remove(); bullets.splice(i, 1); }
            }
        }

        function updateAsteroids() {
            const U = GAME_CONFIG.physics.universeSize;
            for (let i = asteroids.length - 1; i >= 0; i--) {
                let a = asteroids[i]; a.x += a.vx; a.y += a.vy;
                if(a.x > U/2) a.x -= U; if(a.x < -U/2) a.x += U; if(a.y > U/2) a.y -= U; if(a.y < -U/2) a.y += U;
                let dx = getWrappedDiff(a.x, ship.x, U); let dy = getWrappedDiff(a.y, ship.y, U);
                a.el.style.transform = `translate(${(window.innerWidth/2)+dx}px, ${(window.innerHeight/2)+dy}px)`;

                for (let j = bullets.length - 1; j >= 0; j--) {
                    let b = bullets[j]; let bdx = getWrappedDiff(b.x, a.x, U); let bdy = getWrappedDiff(b.y, a.y, U);
                    if(Math.hypot(bdx, bdy) < a.radius) { destroyAsteroid(i, a); b.el.remove(); bullets.splice(j, 1); break; }
                }
                if (asteroids[i] && !mapOpen) { 
                     let sdx = getWrappedDiff(ship.x, a.x, U); let sdy = getWrappedDiff(ship.y, a.y, U);
                     if (Math.hypot(sdx, sdy) < a.radius + 15) { takeDamage(); destroyAsteroid(i, a); }
                }
            }
        }

        function takeDamage() { audio.play('hit'); const o=document.getElementById('damage-overlay'); o.style.opacity = 0.5; setTimeout(()=>o.style.opacity=0,100); addScore(-500); }
        function destroyAsteroid(index, asteroid) { audio.play('hit'); asteroid.el.remove(); asteroids.splice(index, 1); addScore(100*(4-asteroid.size)); if(asteroid.size > 1) spawnAsteroids(2, asteroid.x, asteroid.y, asteroid.size-1); }
        function addScore(amount) { if(amount>0) audio.play('point'); score+=amount; scoreVal.innerText = score; if(score<0) scoreVal.classList.add('negative-score'); else scoreVal.classList.remove('negative-score'); let p=document.createElement('div'); p.className='score-popup '+(amount>0?'score-plus':'score-minus'); p.innerText=(amount>0?"+":"")+amount; scorePopups.appendChild(p); setTimeout(()=>p.remove(),800); }

        function triggerLanding(planet) {
            audio.stopThrust(); audio.stopCharge();
            mode = 'landing_anim'; currentPlanetData = planet; 
            
            planetView.style.background = `linear-gradient(to bottom, ${planet.skyColor} 0%, black 100%)`;
            surfaceContainer.style.background = `radial-gradient(circle at 50% 0%, transparent 50%, rgba(0,0,0,0.8) 100%), ${planet.groundColor}`;
            buildSurfaceCards();
            
            planetView.style.display = 'block';
            setTimeout(() => { spaceView.style.opacity = 0; planetView.style.opacity = 1; }, 100);
            
            setTimeout(() => {
                spaceView.style.display = 'none';
                astro.angle = 0; astro.height = 0; surfaceContainer.style.transform = `rotate(0deg)`;
                
                landedRocket.className = ''; void landedRocket.offsetWidth; 
                landedRocket.classList.add('landing-descent'); landedRocket.classList.add('blasting'); 
                
                audio.startThrust();
                
                setTimeout(() => {
                    audio.stopThrust(); audio.play('launch'); 
                    landedRocket.classList.remove('blasting');
                    mode = 'landed_in_ship'; mainMsg.style.display = 'none';
                    const w = document.getElementById('popup-welcome'); w.innerText = "ATMOSPHERE: " + planet.name; w.style.display = 'block';
                    setTimeout(() => { w.style.display = 'none'; document.getElementById('popup-exit').style.display = 'block'; window.addEventListener('keydown', listenForExit); }, 2500);
                }, 2500); 
            }, 1000);
        }

        function listenForExit(e) { if(e.code === 'Space' && mode === 'landed_in_ship') { window.removeEventListener('keydown', listenForExit); document.getElementById('popup-exit').style.display = 'none'; mode = 'walking'; document.getElementById('astronaut').style.display = 'block'; document.getElementById('popup-enter').style.display = 'none'; interactionCooldown = true; setTimeout(() => interactionCooldown = false, 2000); } }

        function updateWalking() {
            let moving = false; let astronaut = document.getElementById('astronaut'); let body = document.getElementById('astro-body');
            const P = GAME_CONFIG.physics;
            if(keys['ArrowLeft']) { astro.angle += 0.4; astronaut.style.transform = `translateX(-50%) scaleX(-1)`; moving = true; }
            if(keys['ArrowRight']) { astro.angle -= 0.4; astronaut.style.transform = `translateX(-50%) scaleX(1)`; moving = true; }
            if(keys['ArrowUp'] && astro.height <= 0) astro.vy = P.jumpPower;
            astro.height += astro.vy; astro.vy -= P.gravity; if(astro.height < 0) { astro.height = 0; astro.vy = 0; }
            if(moving && astro.height === 0) { astro.bobTimer += 0.15; if(Math.sin(astro.bobTimer) > 0.95) audio.play('step'); body.style.transform = `translateY(${Math.sin(astro.bobTimer)*2}px)`; } else { body.style.transform = `translateY(0)`; }
            surfaceContainer.style.transform = `rotate(${astro.angle}deg)`; astronaut.style.bottom = (300 + astro.height) + 'px';
            if(!currentPlanetData) return; let found = -1;
            currentPlanetData.cards.forEach((c, i) => {
                let cardEl = document.getElementById(`card-${i}`); if(!cardEl) return;
                let rotDiff = Math.abs((astro.angle + c.angle) % 360);
                if(rotDiff > 355 || rotDiff < 5) { found = i; cardEl.style.transform = `rotate(${c.angle}deg) translateY(-2150px) scale(1.1)`; cardEl.style.zIndex = 50; cardEl.style.borderColor = "#00d2ff"; } else { cardEl.style.transform = `rotate(${c.angle}deg) translateY(-2150px) scale(1)`; cardEl.style.zIndex = 1; cardEl.style.borderColor = "#444"; }
            });
            const interactMsg = document.getElementById('popup-interact'); const enterMsg = document.getElementById('popup-enter');
            if(found !== -1 && !interactionCooldown) { nearbyCardIndex = found; interactMsg.style.display = 'block'; } else { nearbyCardIndex = -1; interactMsg.style.display = 'none'; }
            let shipDiff = Math.abs(astro.angle % 360);
            if(shipDiff > 355 || shipDiff < 5) { if(!interactionCooldown) enterMsg.style.display = 'block'; } else { enterMsg.style.display = 'none'; }
        }

        function handleInteraction() {
            if(interactionCooldown) return;
            if(nearbyCardIndex === -1) {
                let shipDiff = Math.abs(astro.angle % 360);
                if(shipDiff > 355 || shipDiff < 5) { mode = 'landed_in_ship'; document.getElementById('astronaut').style.display = 'none'; document.getElementById('popup-enter').style.display = 'none'; mainMsg.style.display = 'block'; mainMsg.innerText = "HOLD CLICK TO LAUNCH"; }
                return;
            }
            openCard(currentPlanetData.cards[nearbyCardIndex]);
        }

        function openCard(card) { 
            mode = 'reading_card'; audio.stopThrust(); audio.play('point'); addScore(1000); 
            modalTitle.innerText = card.title; 
            
            // Render Image inside Modal if it exists
            let imgHTML = card.img ? `<img src="${card.img}" style="max-width: 100%; max-height: 250px; object-fit: cover; border-radius: 8px; border: 2px solid #00d2ff; margin-bottom: 20px;"><br>` : '';
            
            modalDesc.innerHTML = imgHTML + card.desc.replace(/\n/g, '<br>'); 
            cardModal.classList.add('active'); 
        }

        function openPhotoCard(cardData) {
            mode = 'reading_photo'; audio.stopThrust(); audio.play('point'); addScore(2500); 
            modalTitle.innerText = cardData.title; 
            modalDesc.innerHTML = `<img src="${cardData.img}" style="width: 180px; height: 180px; object-fit: cover; border-radius: 50%; border: 4px solid #00d2ff; margin-bottom: 20px;"><br>${cardData.desc.replace(/\n/g, '<br>')}`; 
            cardModal.classList.add('active'); 
        }

        function closeCard() { 
            cardModal.classList.remove('active'); audio.play('point'); interactionCooldown = true; 
            setTimeout(() => { 
                if(mode === 'reading_photo') { mode = 'flying'; } 
                else { mode = 'walking'; }
                interactionCooldown = false; 
            }, 500); 
        }

        function planetTakeoff() {
            mode = 'taking_off'; audio.stopCharge(); audio.play('launch'); mainMsg.style.display = 'none';
            landedRocket.classList.remove('shaking'); landedRocket.classList.add('surface-takeoff', 'blasting');
            spaceView.style.display = 'block'; ship.y -= 600; ship.vx = 0; ship.vy = -5;
            setTimeout(() => { planetView.style.opacity = 0; spaceView.style.opacity = 1; }, 800);
            setTimeout(() => { planetView.style.display = 'none'; landedRocket.classList.remove('surface-takeoff', 'blasting'); mode = 'flying'; }, 2000);
        }
    </script>
</body>
</html>